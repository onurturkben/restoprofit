{% extends 'base.html' %}

{% block content %}
<h1>Analiz Motorları</h1>
<p class="text-muted mb-4">Fiyat kararlarını sade araçlarla modelleyin.</p>

<div class="row g-3">

  <!-- Hedef marj -->
  <div class="col-12">
    <div class="rp-card rp-shadow">
      <div class="rp-card-body">
        <h2>Hedef Marj Hesaplayıcı</h2>
        <form action="{{ url_for('reports') }}" method="POST" class="row g-3 align-items-end">
          <input type="hidden" name="analiz_tipi" value="hedef_marj">
          <div class="col-12 col-md-6">
            <label class="form-label">Ürün</label>
            <select class="form-select" name="urun_ismi" required>
              <option value="" disabled selected>Seçin…</option>
              {% for urun in urun_listesi %}<option value="{{ urun }}">{{ urun }}</option>{% endfor %}
            </select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Hedef Marj (%)</label>
            <input class="form-control" type="number" name="hedef_marj" value="70" min="1" max="99" step="1" required>
          </div>
          <div class="col-6 col-md-3">
            <button class="btn btn-dark w-100">Hesapla</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Simülatör -->
  <div class="col-12">
    <div class="rp-card rp-shadow">
      <div class="rp-card-body">
        <h2>Fiyat Simülatörü</h2>
        <form action="{{ url_for('reports') }}" method="POST" class="row g-3 align-items-end">
          <input type="hidden" name="analiz_tipi" value="simulasyon">
          <div class="col-12 col-md-6">
            <label class="form-label">Ürün</label>
            <select class="form-select" name="urun_ismi" required>
              <option value="" disabled selected>Seçin…</option>
              {% for urun in urun_listesi %}<option value="{{ urun }}">{{ urun }}</option>{% endfor %}
            </select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Yeni Fiyat (TL)</label>
            <input class="form-control" type="number" name="yeni_fiyat" step="0.5" min="1" required>
          </div>
          <div class="col-6 col-md-3">
            <button class="btn btn-dark w-100">Simüle Et</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Optimum fiyat -->
  <div class="col-12">
    <div class="rp-card rp-shadow">
      <div class="rp-card-body">
        <h2>Optimum Fiyat Motoru</h2>
        <form action="{{ url_for('reports') }}" method="POST" class="row g-3 align-items-end">
          <input type="hidden" name="analiz_tipi" value="optimum_fiyat">
          <div class="col-12 col-md-9">
            <label class="form-label">Ürün</label>
            <select class="form-select" name="urun_ismi" required>
              <option value="" disabled selected>Seçin…</option>
              {% for urun in urun_listesi %}<option value="{{ urun }}">{{ urun }}</option>{% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-3">
            <button class="btn btn-dark w-100">Hesapla</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Stratejik analiz -->
  <div class="col-12">
    <div class="rp-card rp-shadow">
      <div class="rp-card-body">
        <h2>Stratejik Analiz</h2>
        <div class="row g-3">
          <form action="{{ url_for('reports') }}" method="POST" class="col-12 col-lg-6">
            <input type="hidden" name="analiz_tipi" value="kategori">
            <label class="form-label">Kategori</label>
            <div class="row g-2">
              <div class="col-12">
                <select class="form-select" name="kategori_ismi" required>
                  <option value="" disabled selected>Seçin…</option>
                  {% for kat in kategori_listesi %}<option value="{{ kat }}">{{ kat }}</option>{% endfor %}
                </select>
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label">Gün</label>
                <input class="form-control" type="number" name="gun_sayisi" value="7" min="1" step="1" required>
              </div>
              <div class="col-12 col-md-8">
                <button class="btn btn-dark w-100">Kategori Analizi</button>
              </div>
            </div>
          </form>

          <form action="{{ url_for('reports') }}" method="POST" class="col-12 col-lg-6">
            <input type="hidden" name="analiz_tipi" value="grup">
            <label class="form-label">Grup</label>
            <div class="row g-2">
              <div class="col-12">
                <select class="form-select" name="grup_ismi" required>
                  <option value="" disabled selected>Seçin…</option>
                  {% for grup in grup_listesi %}<option value="{{ grup }}">{{ grup }}</option>{% endfor %}
                </select>
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label">Gün</label>
                <input class="form-control" type="number" name="gun_sayisi" value="7" min="1" step="1" required>
              </div>
              <div class="col-12 col-md-8">
                <button class="btn btn-dark w-100">Grup Analizi</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  {% if analiz_sonucu %}
  <div class="col-12">
    <div class="rp-card rp-shadow">
      <div class="rp-card-body">
        <h2 class="mb-3">{{ analiz_tipi_baslik }}</h2>
        {% if chart_data %}
        <canvas id="reportChart" height="120"></canvas>
        <hr class="my-4">
        {% endif %}
        <pre class="mb-0" style="background:#fff; border:none; padding:0;">{{ analiz_sonucu }}</pre>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{% if chart_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
(function(){
  try{
    const data = JSON.parse({{ (chart_data or 'null')|tojson|safe }});
    const el = document.getElementById('reportChart'); if(!el||!data) return;
    const type = (data.datasets && data.datasets.length>1) ? 'bar':'line';
    new Chart(el.getContext('2d'), {
      type, data,
      options:{
        responsive:true,
        plugins:{ legend:{position:'top'}, title:{display:false}},
        scales: type==='line' ? {
          x:{ title:{display:true, text:'Satış Fiyatı (TL)'} },
          y:{ title:{display:true, text:'Tahmini Toplam Kâr (TL)'} }
        } : {}
      }
    });
  }catch(e){ console.error(e); }
})();
</script>
{% endif %}
{% endblock %}
