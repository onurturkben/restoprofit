{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">
        
        <div class="text-center">
            <h1>Analiz Motorları</h1>
            <p class="lead text-muted mb-5">
                Fiyat stratejilerinizi belirlemek ve kârlılığınızı optimize etmek için bu araçları kullanın.
            </p>
        </div>

        <!-- Motor 1: Hedef Marj Hesaplayıcı -->
        <div class="card shadow-sm mb-4">
            <div class="card-body p-4 p-lg-5">
                <h3 class="mb-3"><i class="bi bi-bullseye text-primary"></i> Hedef Marj Hesaplayıcı</h3>
                <p class="text-muted">Bir ürünün maliyetine göre, istediğiniz kar marjı için gereken satış fiyatını hesaplar.</p>
                <form action="{{ url_for('reports') }}" method="POST" class="mt-4">
                    <input type="hidden" name="analiz_tipi" value="hedef_marj">
                    <div class="row g-3 align-items-end">
                        <div class="col-sm-6">
                            <label for="hedef_urun" class="form-label">Ürün Seçin:</label>
                            <select class="form-select" name="urun_ismi" id="hedef_urun" required>
                                <option value="" disabled selected>Bir ürün seçin...</option>
                                {% for urun in urun_listesi %}<option value="{{ urun }}">{{ urun }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-3">
                            <label for="hedef_marj" class="form-label">Hedef Marj (%)</label>
                            <input type="number" class="form-control" name="hedef_marj" id="hedef_marj" value="70" step="1" min="1" max="99" required>
                        </div>
                        <div class="col-sm-3">
                            <button type="submit" class="btn btn-dark w-100">Hesapla</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Motor 2: Fiyat Simülatörü -->
        <section class="card shadow-sm mb-4">
            <div class="card-body p-4 p-lg-5">
                <h3 class="mb-3"><i class="bi bi-graph-up-arrow"></i> Fiyat Simülatörü</h3>
                <p class="text-muted">"Ya... olursa?" analizi. Bir ürünün fiyatını değiştirirseniz tahmini karınızın ne olacağını söyler.</p>
                <form action="{{ url_for('reports') }}" method="POST" class="mt-4">
                    <input type="hidden" name="analiz_tipi" value="simulasyon">
                    <div class="row g-3 align-items-end">
                        <div class="col-sm-6">
                            <label for="sim_urun" class="form-label">Ürün</label>
                            <select class="form-select" name="urun_ismi" id="sim_urun" required>
                                <option value="" disabled selected>Bir ürün seçin...</option>
                                {% for urun in urun_listesi %}<option value="{{ urun }}">{{ urun }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-3">
                            <label for="yeni_fiyat" class="form-label">Yeni Fiyat (TL)</label>
                            <input type="number" class="form-control" name="yeni_fiyat" placeholder="Örn: 150" step="0.5" min="1" required>
                        </div>
                        <div class="col-sm-3">
                            <button type="submit" class="btn btn-dark w-100">Simüle Et</button>
                        </div>
                    </div>
                </form>
            </div>
        </section>

        <!-- Motor 3: Optimum Fiyat Motoru -->
        <section class="card shadow-sm mb-4">
            <div class="card-body p-4 p-lg-5">
                <h3 class="mb-3"><i class="bi bi-gem"></i> Optimum Fiyat Motoru</h3>
                <p class="text-muted">Bir ürün için "Maksimum Kâr" getirecek fiyatı, geçmiş verilere dayanarak tahmin eder.</p>
                <form action="{{ url_for('reports') }}" method="POST" class="mt-4">
                    <input type="hidden" name="analiz_tipi" value="optimum_fiyat">
                    <div class="row g-3 align-items-end">
                        <div class="col-sm-9">
                            <label for="opt_urun" class="form-label">Ürün</Vlabel>
                            <select class="form-select" name="urun_ismi" id="opt_urun" required>
                                <option value="" disabled selected>Bir ürün seçin...</option>
                                {% for urun in urun_listesi %}<option value="{{ urun }}">{{ urun }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-3">
                            <button type="submit" class="btn btn-dark w-100">Hesapla</button>
                        </div>
                    </div>
                </form>
            </div>
        </section>
        
        <!-- Motor 4 & 5: Strateji Analizleri -->
        <section class="card shadow-sm mb-5">
            <div class="card-body p-4 p-lg-5">
                <h3><i class="bi bi-diagram-3"></i> Stratejik Analiz</h3>
                <p class="text-muted">Ürünlerin birbirini nasıl etkilediğini (yamyamlık) kategori veya grup bazında analiz edin.</p>
                <!-- Kategori Analizi Formu -->
                <form action="{{ url_for('reports') }}" method="POST" class="mt-4">
                    <input type="hidden" name="analiz_tipi" value="kategori">
                     <div class="row g-3 align-items-end">
                        <div class="col-sm-6">
                            <label for="kategori_isim" class="form-label">Kategori Seçin</label>
                            <select class="form-select" name="kategori_ismi" id="kategori_isim" required>
                                <option value="" disabled selected>Bir kategori seçin...</option>
                                {% for kat in kategori_listesi %}<option value="{{ kat }}">{{ kat }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-3">
                            <label for="gun_kat" class="form-label">Periyot (Gün)</label>
                            <input type="number" class="form-control" name="gun_sayisi" id="gun_kat" value="7" step="1" min="1" required>
                        </div>
                         <div class="col-sm-3">
                            <button type="submit" class="btn btn-dark w-100">Kategori Analizi</button>
                        </div>
                    </div>
                </form>
                <!-- Kategori Grubu Analizi Formu -->
                <form action="{{ url_for('reports') }}" method="POST" class="mt-3 pt-3 border-top">
                    <input type="hidden" name="analiz_tipi" value="grup">
                     <div class="row g-3 align-items-end">
                        <div class="col-sm-6">
                            <label for="grup_isim" class="form-label">Grup Seçin</label>
                            <select class="form-select" name="grup_ismi" id="grup_isim" required>
                                <option value="" disabled selected>Bir grup seçin...</option>
                                {% for grup in grup_listesi %}<option value="{{ grup }}">{{ grup }}</option>{% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-3">
                            <label for="gun_grup" class="form-label">Periyot (Gün)</label>
                            <input type="number" class="form-control" name="gun_sayisi" id="gun_grup" value="7" step="1" min="1" required>
                        </div>
                         <div class="col-sm-3">
                            <button type="submit" class="btn btn-dark w-100">Grup Analizi</button>
                        </div>
                    </div>
                </form>
            </div>
        </section>

        <!-- Analiz Sonucu Alanı -->
        {% if analiz_sonucu %}
        <div class="mb-5">
            <h2 class="mb-4">Analiz Sonucu: {{ analiz_tipi_baslik }}</h2>
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    {% if chart_data %}
                    <div>
                        <canvas id="myChart"></canvas>
                    </div>
                    <hr class="my-4">
                    {% endif %}
                    <pre class="mb-0" style="background-color: #fff; border: none; padding: 0;">{{ analiz_sonucu }}</pre>
                </div>
            </div>
        </div>
        {% endif %}
        
    </div> <!-- /col -->
</div> <!-- /row -->
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Chart.js'i (Grafik kütüphanesi) yüklüyoruz -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', (event) => {
    // chart_data değişkeni Flask tarafından sayfaya gömüldü mü kontrol et
    {% if chart_data %}
        try {
            // Flask'tan gelen JSON string'ini JavaScript objesine çevir
            const chartData = JSON.parse({{ chart_data | tojson | safe }});
            
            const ctx = document.getElementById('myChart').getContext('2d');
            
            // Eğer veri 'price_points' ise (Optimum Fiyat Motoru)
            if (chartData.price_points) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.price_points,
                        datasets: [{
                            label: 'Tahmini Toplam Kâr (TL)',
                            data: chartData.profit_points,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Fiyat Elastikiyeti ve Kâr Optimizasyonu'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Satış Fiyatı (TL)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Tahmini Toplam Kâr (TL)'
                                }
                            }
                        }
                    }
                });
            }
            // Eğer veri 'labels' ise (Kategori/Grup Analizi)
            else if (chartData.labels) {
                new Chart(ctx, {
                    type: 'doughnut', // Pasta grafik
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: 'Dönem Başı Kâr Payı',
                            data: chartData.previous_profits,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)'
                            ],
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        {
                            label: 'Dönem Sonu Kâr Payı',
                            data: chartData.current_profits,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)'
                            ],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Kategori/Grup Kâr Dağılımı (Önceki vs. Şimdiki Dönem)'
                            }
                        }
                    }
                });
            }
        } catch (e) {
            console.error("Grafik verisi ayrıştırılamadı veya çizilemedi:", e);
        }
    {% endif %}
});
</script>
{% endblock %}
