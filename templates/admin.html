{% extends 'base.html' %}

{% block content %}

<div class="container-xxl" style="max-width:1200px;">
  <header class="mb-5">
    <h1 class="fw-bold" style="font-size:32px; line-height:40px;">MenÃ¼ YÃ¶netimi</h1>
    <p class="text-muted" style="line-height:1.6;">ÃœrÃ¼nler, hammaddeler ve tarifleri sade bir akÄ±ÅŸla yÃ¶netin.</p>
  </header>

  <!-- HÄ±zlÄ± aksiyonlar -->
  <div class="rp-admin-actions d-flex flex-wrap gap-2 mb-4">
    <button class="btn btn-dark rp-action-btn" data-bs-toggle="modal" data-bs-target="#modalAddMaterial">
      <span class="rp-action-ic" aria-hidden="true">ğŸ§‚</span>
      <span>Hammadde Ekle</span>
    </button>
    <button class="btn btn-dark rp-action-btn" data-bs-toggle="modal" data-bs-target="#modalAddProduct">
      <span class="rp-action-ic" aria-hidden="true">ğŸ”</span>
      <span>ÃœrÃ¼n Ekle</span>
    </button>
    <button class="btn btn-success rp-action-btn" data-bs-toggle="modal" data-bs-target="#modalAddRecipe">
      <span class="rp-action-ic" aria-hidden="true">ğŸ§¾</span>
      <span>Tarif Ekle</span>
    </button>
  </div>

  <!-- Ã–zet kutularÄ± -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
      <div class="rp-stat p-4 bg-white rounded-3 border">
        <div class="d-flex align-items-start justify-content-between">
          <div>
            <div class="text-muted small mb-1">Hammadde</div>
            <div class="rp-stat-num">{{ hammaddeler|length }}</div>
            <div class="rp-stat-label">KayÄ±tlÄ± hammadde</div>
          </div>
          <div class="rp-stat-ic" aria-hidden="true">ğŸ§‚</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="rp-stat p-4 bg-white rounded-3 border">
        <div class="d-flex align-items-start justify-content-between">
          <div>
            <div class="text-muted small mb-1">ÃœrÃ¼n</div>
            <div class="rp-stat-num">{{ urunler|length }}</div>
            <div class="rp-stat-label">MenÃ¼deki Ã¼rÃ¼n</div>
          </div>
          <div class="rp-stat-ic" aria-hidden="true">ğŸ”</div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="rp-stat p-4 bg-white rounded-3 border">
        <div class="d-flex align-items-start justify-content-between">
          <div>
            <div class="text-muted small mb-1">Tarif</div>
            <div class="rp-stat-num">
              {% if recete_pagination %}{{ recete_pagination.total }}{% else %}{{ receteler|length }}{% endif %}
            </div>
            <div class="rp-stat-label">Toplam tarif kalemi</div>
          </div>
          <div class="rp-stat-ic" aria-hidden="true">ğŸ§¾</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sekmeler -->
  <ul class="nav nav-pills rp-admin-tabs mb-3" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pane-mats" type="button">
        Hammaddeler
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-products" type="button">
        ÃœrÃ¼nler
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-recipes" type="button">
        Tarifler
      </button>
    </li>
  </ul>

  <div class="tab-content">

    <!-- Hammaddeler -->
    <section id="pane-mats" class="tab-pane fade show active">
      <div class="bg-white rounded-3 border rp-panel">
        <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between p-3 p-md-4 border-bottom rp-panel-head">
          <h3 class="m-0 fw-bold" style="font-size:20px; line-height:24px;">Hammadde Listesi</h3>

          <div class="rp-search-wrap" style="max-width:320px; width:100%;">
            <span class="rp-search-ic" aria-hidden="true">ğŸ”</span>
            <input id="filterMats" type="search" class="form-control form-control-sm rp-search" placeholder="Araâ€¦" />
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle mb-0 rp-table" style="--bs-table-bg:transparent;">
            <thead class="table-light">
              <tr>
                <th>Ad</th>
                <th style="width:140px;">Birim</th>
                <th style="width:160px;">Birim Fiyat (TL)</th>
                <th class="text-end" style="width:120px;">Ä°ÅŸlem</th>
              </tr>
            </thead>
            <tbody id="matsTbody">
              {% for h in hammaddeler %}
              <tr>
                <td class="text-truncate">{{ h.isim }}</td>
                <td class="text-muted">{{ h.maliyet_birimi }}</td>
                <td>{{ "%.2f"|format(h.maliyet_fiyati) }}</td>
                <td class="text-end">
                  <div class="rp-row-actions">
                    <button class="btn btn-sm rp-btn-icon rp-btn-ghost"
                            title="DÃ¼zenle"
                            data-bs-toggle="modal" data-bs-target="#modalEditMaterial"
                            data-id="{{ h.id }}" data-isim="{{ h.isim }}"
                            data-birim="{{ h.maliyet_birimi }}" data-fiyat="{{ h.maliyet_fiyati }}">
                      âœï¸
                    </button>
                    <form action="{{ url_for('delete_material', id=h.id) }}" method="POST" class="d-inline"
                          onsubmit="return confirm('`{{ h.isim }}` hammaddesini silmek istiyor musunuz?');">
                      <button class="btn btn-sm rp-btn-icon rp-btn-danger" title="Sil">ğŸ—‘ï¸</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="4" class="text-center text-muted py-4">Hammadde yok.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ÃœrÃ¼nler -->
    <section id="pane-products" class="tab-pane fade">
      <div class="bg-white rounded-3 border rp-panel">
        <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between p-3 p-md-4 border-bottom rp-panel-head">
          <h3 class="m-0 fw-bold" style="font-size:20px; line-height:24px;">ÃœrÃ¼n Listesi</h3>

          <div class="rp-search-wrap" style="max-width:420px; width:100%;">
            <span class="rp-search-ic" aria-hidden="true">ğŸ”</span>
            <input id="filterProducts" type="search" class="form-control form-control-sm rp-search" placeholder="Araâ€¦" />
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle mb-0 rp-table">
            <thead class="table-light">
              <tr>
                <th>Ä°sim</th>
                <th>Excel</th>
                <th>Kategori</th>
                <th>Grup</th>
                <th style="width:120px;">Fiyat</th>
                <th style="width:120px;">Maliyet</th>
                <th class="text-end" style="width:120px;">Ä°ÅŸlem</th>
              </tr>
            </thead>
            <tbody id="productsTbody">
              {% for u in urunler %}
              <tr>
                <td class="text-truncate">{{ u.isim }}</td>
                <td class="text-muted text-truncate">{{ u.excel_adi }}</td>
                <td class="text-truncate">{{ u.kategori }}</td>
                <td class="text-truncate">{{ u.kategori_grubu }}</td>
                <td>{{ "%.2f"|format(u.mevcut_satis_fiyati) }}</td>
                <td>{{ "%.2f"|format(u.hesaplanan_maliyet) }}</td>
                <td class="text-end">
                  <div class="rp-row-actions">
                    <button class="btn btn-sm rp-btn-icon rp-btn-ghost"
                            title="DÃ¼zenle"
                            data-bs-toggle="modal" data-bs-target="#modalEditProduct"
                            data-id="{{ u.id }}" data-isim="{{ u.isim }}"
                            data-excel_adi="{{ u.excel_adi }}" data-fiyat="{{ u.mevcut_satis_fiyati }}"
                            data-kategori="{{ u.kategori }}" data-grup="{{ u.kategori_grubu }}">
                      âœï¸
                    </button>
                    <form action="{{ url_for('delete_product', id=u.id) }}" method="POST" class="d-inline"
                          onsubmit="return confirm('`{{ u.isim }}` Ã¼rÃ¼nÃ¼nÃ¼ silmek istiyor musunuz?');">
                      <button class="btn btn-sm rp-btn-icon rp-btn-danger" title="Sil">ğŸ—‘ï¸</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="7" class="text-center text-muted py-4">ÃœrÃ¼n yok.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Tarifler (eski: ReÃ§eteler) -->
    <section id="pane-recipes" class="tab-pane fade">
      <div class="bg-white rounded-3 border rp-panel">
        <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between p-3 p-md-4 border-bottom rp-panel-head">
          <h3 class="m-0 fw-bold" style="font-size:20px; line-height:24px;">Tarifler</h3>

          <div class="rp-search-wrap" style="max-width:320px; width:100%;">
            <span class="rp-search-ic" aria-hidden="true">ğŸ”</span>
            <input id="filterRecipes" type="search" class="form-control form-control-sm rp-search" placeholder="Araâ€¦" />
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle mb-0 rp-table">
            <thead class="table-light">
              <tr>
                <th>ÃœrÃ¼n</th>
                <th>Hammadde</th>
                <th style="width:140px;">Miktar</th>
                <th style="width:100px;">Birim</th>
                <th class="text-end" style="width:120px;">Ä°ÅŸlem</th>
              </tr>
            </thead>
            <tbody id="recipesTbody">
              {% for r in receteler %}
              <tr>
                <td class="text-truncate">{{ r.urun.isim }}</td>
                <td class="text-truncate">{{ r.hammadde.isim }}</td>
                <td>{{ r.miktar }}</td>
                <td class="text-muted">{{ r.hammadde.maliyet_birimi }}</td>
                <td class="text-end">
                  <div class="rp-row-actions">
                    <button class="btn btn-sm rp-btn-icon rp-btn-ghost"
                            title="DÃ¼zenle"
                            data-bs-toggle="modal" data-bs-target="#modalEditRecipe"
                            data-id="{{ r.id }}" data-urun="{{ r.urun.isim }}"
                            data-hammadde="{{ r.hammadde.isim }}" data-miktar="{{ r.miktar }}"
                            data-birim="{{ r.hammadde.maliyet_birimi }}">
                      âœï¸
                    </button>
                    <form action="{{ url_for('delete_recipe', id=r.id) }}" method="POST" class="d-inline"
                          onsubmit="return confirm('Bu tarif kalemini silmek istiyor musunuz?');">
                      <button class="btn btn-sm rp-btn-icon rp-btn-danger" title="Sil">ğŸ—‘ï¸</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="5" class="text-center text-muted py-4">Tarif kalemi yok.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if recete_pagination %}
        <div class="p-3 p-md-4 border-top">
          <nav aria-label="Tarif Sayfalama">
            <ul class="pagination pagination-sm mb-0 justify-content-end">
              <li class="page-item {% if not recete_pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('admin_panel', page=recete_pagination.prev_num, per=recete_pagination.per_page) }}">Ã–nceki</a>
              </li>
              <li class="page-item disabled">
                <span class="page-link">Sayfa {{ recete_pagination.page }} / {{ recete_pagination.pages }}</span>
              </li>
              <li class="page-item {% if not recete_pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('admin_panel', page=recete_pagination.next_num, per=recete_pagination.per_page) }}">Sonraki</a>
              </li>
            </ul>
          </nav>
        </div>
        {% endif %}
      </div>
    </section>

  </div>

  <!-- Tehlikeli bÃ¶lge -->
  <section class="mt-5">
    <div class="p-4 border rounded-3 rp-danger-zone">
      <h3 class="fw-bold mb-3" style="font-size:20px; line-height:24px;">SatÄ±ÅŸ Sil (Tarihe gÃ¶re)</h3>
      <form action="{{ url_for('delete_sales_by_date') }}" method="POST"
            onsubmit="return confirm('SeÃ§tiÄŸiniz tarihteki TÃœM satÄ±ÅŸ kayÄ±tlarÄ± silinecek. Emin misiniz?');">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-sm-4">
            <label class="form-label">Tarih</label>
            <input type="date" name="delete_date" class="form-control" required>
          </div>
          <div class="col-12 col-sm-8">
            <button class="btn btn-outline-danger w-100">SeÃ§ili Tarihteki SatÄ±ÅŸlarÄ± Sil</button>
          </div>
        </div>
      </form>
    </div>
  </section>
</div>

{% include 'modals.html' %}

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function () {
  // Basit filtre: input iÃ§eriÄŸi satÄ±r metninde geÃ§iyorsa gÃ¶ster
  const attachFilter = (inputId, tbodyId) => {
    const q = document.getElementById(inputId);
    const tb = document.getElementById(tbodyId);
    if (!q || !tb) return;
    q.addEventListener('input', () => {
      const v = q.value.trim().toLowerCase();
      [...tb.rows].forEach(tr => tr.style.display = tr.innerText.toLowerCase().includes(v) ? '' : 'none');
    });
  };
  attachFilter('filterMats', 'matsTbody');
  attachFilter('filterProducts', 'productsTbody');
  attachFilter('filterRecipes', 'recipesTbody');

  // DÃ¼zenleme modallarÄ±: tetikleyen butondan verileri doldur
  const onShow = (id, fill) => {
    const m = document.getElementById(id);
    if (!m) return;
    m.addEventListener('show.bs.modal', e => fill(m, (e.relatedTarget||{}).dataset||{}));
  };

  onShow('modalEditMaterial', (m,d) => {
    m.querySelector('form').action = "{{ url_for('edit_material', id=0) }}".replace('0', d.id);
    m.querySelector('[name=isim]').value  = d.isim || '';
    m.querySelector('[name=birim]').value = d.birim || '';
    m.querySelector('[name=fiyat]').value = d.fiyat || '';
  });

  onShow('modalEditProduct', (m,d) => {
    m.querySelector('form').action = "{{ url_for('edit_product', id=0) }}".replace('0', d.id);
    m.querySelector('[name=isim]').value      = d.isim || '';
    m.querySelector('[name=excel_adi]').value = d.excel_adi || '';
    m.querySelector('[name=fiyat]').value     = d.fiyat || '';
    m.querySelector('[name=kategori]').value  = d.kategori || '';
    m.querySelector('[name=grup]').value      = d.grup || '';
  });

  onShow('modalEditRecipe', (m,d) => {
    m.querySelector('form').action = "{{ url_for('edit_recipe', id=0) }}".replace('0', d.id);
    m.querySelector('#recUrun').textContent       = d.urun || '';
    m.querySelector('#recHammadde').textContent   = d.hammadde || '';
    m.querySelector('#recBirim').textContent      = d.birim || '';
    m.querySelector('[name=edit_r_miktar]').value = d.miktar || '';
  });
})();
</script>
{% endblock %}
